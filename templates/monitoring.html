{% extends "base.html" %}

{% block content %}
<div class="py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-chart-line"></i> Monitoring & Metrics</h1>
        <div class="btn-group">
            <button class="btn btn-outline-primary" onclick="refreshMetrics()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
            <button class="btn btn-outline-secondary" onclick="exportMetrics()">
                <i class="fas fa-download"></i> Export
            </button>
        </div>
    </div>
    
    <!-- Time Range Selector -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title">Time Range</h6>
                    <div class="btn-group w-100" role="group" id="time-range-selector">
                        <input type="radio" class="btn-check" name="timeRange" id="range-1h" value="1h" checked>
                        <label class="btn btn-outline-primary" for="range-1h">1 Hour</label>
                        
                        <input type="radio" class="btn-check" name="timeRange" id="range-24h" value="24h">
                        <label class="btn btn-outline-primary" for="range-24h">24 Hours</label>
                        
                        <input type="radio" class="btn-check" name="timeRange" id="range-7d" value="7d">
                        <label class="btn btn-outline-primary" for="range-7d">7 Days</label>
                        
                        <input type="radio" class="btn-check" name="timeRange" id="range-30d" value="30d">
                        <label class="btn btn-outline-primary" for="range-30d">30 Days</label>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title">System Status</h6>
                    <div class="d-flex align-items-center">
                        <span class="status-indicator status-healthy me-2"></span>
                        <span id="overall-status">All Systems Operational</span>
                        <div class="ms-auto">
                            <small class="text-muted" id="last-updated">Last updated: --</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Key Performance Metrics -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card metric-card">
                <div class="card-body text-center">
                    <i class="fas fa-tachometer-alt fa-2x text-primary mb-2"></i>
                    <h4 class="text-primary mb-1" id="avg-execution-time">--</h4>
                    <p class="text-muted mb-0">Avg Execution Time</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card metric-card">
                <div class="card-body text-center">
                    <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                    <h4 class="text-success mb-1" id="success-rate">--</h4>
                    <p class="text-muted mb-0">Success Rate</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card metric-card">
                <div class="card-body text-center">
                    <i class="fas fa-database fa-2x text-info mb-2"></i>
                    <h4 class="text-info mb-1" id="data-throughput">--</h4>
                    <p class="text-muted mb-0">Data Throughput</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card metric-card">
                <div class="card-body text-center">
                    <i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i>
                    <h4 class="text-warning mb-1" id="error-count">--</h4>
                    <p class="text-muted mb-0">Errors (24h)</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Charts Section -->
    <div class="row mb-4">
        <!-- Pipeline Performance Chart -->
        <div class="col-lg-8 mb-4">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="fas fa-chart-area"></i> Pipeline Performance Over Time</h6>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary active" onclick="switchChart('performance', 'executions')">Executions</button>
                            <button class="btn btn-outline-secondary" onclick="switchChart('performance', 'duration')">Duration</button>
                            <button class="btn btn-outline-secondary" onclick="switchChart('performance', 'errors')">Errors</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div style="height: 300px; width: 100%; position: relative;">
                        <canvas id="performance-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- System Resources Chart -->
        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-server"></i> System Resources</h6>
                </div>
                <div class="card-body">
                    <div style="height: 300px; width: 100%; position: relative;">
                        <canvas id="resources-chart"></canvas>
                    </div>
                    <div class="mt-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class="fas fa-circle text-primary"></i> CPU</span>
                            <span id="cpu-usage">--</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class="fas fa-circle text-success"></i> Memory</span>
                            <span id="memory-usage">--</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span><i class="fas fa-circle text-warning"></i> Disk</span>
                            <span id="disk-usage">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Data Quality Metrics -->
    <div class="row mb-4">
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-shield-alt"></i> Data Quality Score</h6>
                </div>
                <div class="card-body">
                    <div style="height: 250px; width: 100%; position: relative;">
                        <canvas id="quality-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Pipeline Status Distribution -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-pie-chart"></i> Pipeline Status Distribution</h6>
                </div>
                <div class="card-body">
                    <div style="height: 250px; width: 100%; position: relative;">
                        <canvas id="status-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Activity Table -->
    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="fas fa-history"></i> Recent Activity</h6>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary active" onclick="switchActivityView('all')">All</button>
                    <button class="btn btn-outline-secondary" onclick="switchActivityView('success')">Success</button>
                    <button class="btn btn-outline-secondary" onclick="switchActivityView('error')">Errors</button>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Pipeline</th>
                            <th>Status</th>
                            <th>Duration</th>
                            <th>Rows</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="activity-table">
                        <tr>
                            <td colspan="6" class="text-center">Loading activity...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let performanceChart, resourcesChart, qualityChart, statusChart;
let currentTimeRange = '1h';
let currentChartView = 'executions';
let currentActivityView = 'all';

// Initialize all charts
function initCharts() {
    initPerformanceChart();
    initResourcesChart();
    initQualityChart();
    initStatusChart();
}

function initPerformanceChart() {
    const ctx = document.getElementById('performance-chart').getContext('2d');
    performanceChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Executions',
                data: [],
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

function initResourcesChart() {
    const ctx = document.getElementById('resources-chart').getContext('2d');
    resourcesChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['CPU', 'Memory', 'Disk'],
            datasets: [{
                data: [0, 0, 0],
                backgroundColor: ['#007bff', '#28a745', '#ffc107'],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            layout: {
                padding: 10
            },
            elements: {
                arc: {
                    borderWidth: 2
                }
            }
        }
    });
}

function initQualityChart() {
    const ctx = document.getElementById('quality-chart').getContext('2d');
    qualityChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Completeness', 'Accuracy', 'Consistency', 'Validity', 'Uniqueness'],
            datasets: [{
                data: [0, 0, 0, 0, 0],  // Start with zeros, will be updated with real data
                backgroundColor: ['#28a745', '#17a2b8', '#ffc107', '#dc3545', '#6f42c1']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

function initStatusChart() {
    const ctx = document.getElementById('status-chart').getContext('2d');
    statusChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['Success', 'Running', 'Failed', 'Queued'],
            datasets: [{
                data: [0, 0, 0, 0],  // Start with zeros, will be updated with real pipeline status data
                backgroundColor: ['#28a745', '#17a2b8', '#dc3545', '#6c757d']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

// Load metrics data
async function loadMetrics() {
    try {
        // Show loading indicator
        const statusEl = document.getElementById('overall-status');
        const originalText = statusEl.textContent;
        statusEl.textContent = 'Loading metrics...';
        
        const response = await axios.get(`/api/metrics?window=${currentTimeRange}`);
        const metrics = response.data.metrics;
        
        // Load quality metrics separately
        await loadQualityMetrics();
        
        // Restore original status
        statusEl.textContent = originalText;
        
        updateKPIs(metrics);
        updateCharts(metrics);
        updateStatusChart(metrics);
        updateLastUpdated();
        
    } catch (error) {
        console.error('Error loading metrics:', error);
        document.getElementById('overall-status').textContent = 'Error loading metrics';
        document.getElementById('overall-status').className = 'text-danger';
    }
}

// Load real quality metrics from database
async function loadQualityMetrics() {
    try {
        const response = await axios.get('/api/quality-metrics');
        const qualityData = response.data;
        
        if (qualityData.quality_metrics && qualityChart) {
            const metrics = qualityData.quality_metrics;
            
            // Update quality chart with real data
            qualityChart.data.datasets[0].data = [
                metrics.completeness,
                metrics.accuracy,
                metrics.consistency,
                metrics.validity,
                metrics.uniqueness
            ];
            qualityChart.update('none');
            
            // Show data availability status
            if (!qualityData.data_available) {
                console.log('No quality metrics data available - run pipeline with quality validation to see data');
            }
        }
        
    } catch (error) {
        console.error('Error loading quality metrics:', error);
        // Keep chart at zeros if error occurs
    }
}

function updateKPIs(metrics) {
    // Update average execution time
    const avgTime = metrics.pipeline_duration_seconds?.avg || 0;
    document.getElementById('avg-execution-time').textContent = avgTime + 's';
    
    // Update success rate
    const totalExecs = metrics.pipeline_executions_total?.sum || 1;
    const successExecs = metrics.pipeline_success_total?.sum || 0;
    const successRate = Math.round((successExecs / totalExecs) * 100);
    document.getElementById('success-rate').textContent = successRate + '%';
    
    // Update data throughput
    const rowsProcessed = metrics.data_rows_processed_total?.sum || 0;
    document.getElementById('data-throughput').textContent = (rowsProcessed / 1000).toFixed(1) + 'K rows';
    
    // Update error count
    const errors = metrics.pipeline_failure_total?.sum || 0;
    document.getElementById('error-count').textContent = errors;
    
    // Update system resources
    document.getElementById('cpu-usage').textContent = (metrics.system_cpu_usage_percent?.latest || 0) + '%';
    document.getElementById('memory-usage').textContent = (metrics.system_memory_usage_percent?.latest || 0) + '%';
    document.getElementById('disk-usage').textContent = (metrics.system_disk_usage_percent?.latest || 0) + '%';
}

function updateCharts(metrics) {
    try {
        // Avoid unnecessary updates and use real data
        if (!performanceChart || !resourcesChart) return;
        
        // Update performance chart with real data - REDUCE DATA POINTS FOR PERFORMANCE
        const executions = metrics.pipeline_executions_total;
        const now = new Date();
        const labels = [];
        const data = [];
        
        // SIGNIFICANTLY reduce data points to fix performance issue
        const dataPoints = currentTimeRange === '1h' ? 6 : currentTimeRange === '24h' ? 8 : 5;
        let interval, formatTime;
        
        if (currentTimeRange === '1h') {
            interval = 10 * 60 * 1000; // 10 minutes instead of 5
            formatTime = (d) => d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        } else if (currentTimeRange === '24h') {
            interval = 3 * 60 * 60 * 1000; // 3 hours instead of 1
            formatTime = (d) => d.toLocaleTimeString([], {hour: '2-digit'}) + ':00';
        } else {
            interval = 24 * 60 * 60 * 1000; // 1 day
            formatTime = (d) => d.toLocaleDateString([], {month: 'short', day: 'numeric'});
        }
        
        for (let i = dataPoints - 1; i >= 0; i--) {
            const time = new Date(now.getTime() - i * interval);
            labels.push(formatTime(time));
            // Only use actual metric data, no fake data
            const value = executions?.latest || 0;
            data.push(value);
        }
        
        // FIXED: Prevent chart data memory leaks by limiting updates and reusing arrays
        if (performanceChart.data.labels.length !== labels.length) {
            performanceChart.data.labels.length = 0;
            performanceChart.data.datasets[0].data.length = 0;
            performanceChart.data.labels.push(...labels);
            performanceChart.data.datasets[0].data.push(...data);
        } else {
            // Update existing arrays to prevent memory leak
            for (let i = 0; i < labels.length; i++) {
                performanceChart.data.labels[i] = labels[i];
                performanceChart.data.datasets[0].data[i] = data[i];
            }
        }
        performanceChart.update('none');
        
        // FIX DATA LEAK - Update resources chart without creating new arrays
        const cpu = Math.min(100, Math.max(0, metrics.system_cpu_usage_percent?.latest || 0));
        const memory = Math.min(100, Math.max(0, metrics.system_memory_usage_percent?.latest || 0));
        const disk = Math.min(100, Math.max(0, metrics.system_disk_usage_percent?.latest || 0));
        
        resourcesChart.data.datasets[0].data[0] = cpu;
        resourcesChart.data.datasets[0].data[1] = memory;
        resourcesChart.data.datasets[0].data[2] = disk;
        resourcesChart.update('none');
        
    } catch (error) {
        console.error('Error updating charts:', error);
    }
}

function updateStatusChart(metrics) {
    try {
        // Update status chart with real pipeline status data
        const statusData = metrics.pipeline_status_distribution || {};
        
        if (statusChart) {
            statusChart.data.datasets[0].data = [
                statusData.success || 0,
                statusData.running || 0,
                statusData.failed || 0,
                statusData.queued || 0
            ];
            statusChart.update('none');
        }
        
    } catch (error) {
        console.error('Error updating status chart:', error);
    }
}

function updateLastUpdated() {
    document.getElementById('last-updated').textContent = 'Last updated: ' + new Date().toLocaleTimeString();
}

// Load activity data
async function loadActivity() {
    try {
        // Load actual pipeline execution history
        // For now, show empty until real executions happen
        const activities = [];
        
        updateActivityTable(activities);
        
    } catch (error) {
        console.error('Error loading activity:', error);
    }
}

function updateActivityTable(activities) {
    const tbody = document.getElementById('activity-table');
    
    const filteredActivities = currentActivityView === 'all' ? activities : 
        activities.filter(a => a.status === currentActivityView);
    
    if (filteredActivities.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No pipeline executions yet. Execute a pipeline to see activity here.</td></tr>';
        return;
    }
    
    const rowsHtml = filteredActivities.map(activity => {
        const statusClass = activity.status === 'success' ? 'success' : 
                           activity.status === 'error' ? 'danger' : 'warning';
        
        return `
            <tr>
                <td><small>${activity.time}</small></td>
                <td>${activity.pipeline}</td>
                <td><span class="badge bg-${statusClass}">${activity.status}</span></td>
                <td>${activity.duration}</td>
                <td>${activity.rows.toLocaleString()}</td>
                <td>
                    <button class="btn btn-outline-primary btn-sm" onclick="viewPipelineDetails('${activity.pipeline}')">
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
    
    tbody.innerHTML = rowsHtml;
}

// Event handlers
function refreshMetrics() {
    // Show visual feedback that refresh is working
    const refreshBtn = document.querySelector('[onclick="refreshMetrics()"]');
    const originalContent = refreshBtn.innerHTML;
    
    // Show spinner
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
    refreshBtn.disabled = true;
    
    // Load data
    Promise.all([loadMetrics(), loadActivity()]).then(() => {
        // Success feedback
        refreshBtn.innerHTML = '<i class="fas fa-check"></i> Updated';
        refreshBtn.classList.add('btn-success');
        refreshBtn.classList.remove('btn-outline-secondary');
        
        // Reset after 2 seconds
        setTimeout(() => {
            refreshBtn.innerHTML = originalContent;
            refreshBtn.disabled = false;
            refreshBtn.classList.remove('btn-success');
            refreshBtn.classList.add('btn-outline-secondary');
        }, 2000);
        
    }).catch((error) => {
        console.error('Refresh error:', error);
        
        // Error feedback  
        refreshBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
        refreshBtn.classList.add('btn-danger');
        refreshBtn.classList.remove('btn-outline-secondary');
        
        // Reset after 3 seconds
        setTimeout(() => {
            refreshBtn.innerHTML = originalContent;
            refreshBtn.disabled = false;
            refreshBtn.classList.remove('btn-danger');
            refreshBtn.classList.add('btn-outline-secondary');
        }, 3000);
    });
}

async function exportMetrics() {
    try {
        // Show loading indicator
        const originalText = document.querySelector('[onclick="exportMetrics()"]').innerHTML;
        document.querySelector('[onclick="exportMetrics()"]').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exporting...';
        
        // Make request to export API
        const response = await axios.get(`/api/export-metrics?format=csv&window=${currentTimeRange}`, {
            responseType: 'blob'  // Important for file downloads
        });
        
        // Create download link
        const blob = new Blob([response.data], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        
        // Set filename with current date
        const date = new Date().toISOString().split('T')[0];
        link.download = `metrics_export_${date}.csv`;
        
        // Trigger download
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);
        
        // Show success message
        console.log('âœ… Metrics exported successfully');
        
        // Restore button text
        document.querySelector('[onclick="exportMetrics()"]').innerHTML = originalText;
        
    } catch (error) {
        console.error('Error exporting metrics:', error);
        alert('Error exporting metrics. Please try again.');
        
        // Restore button text
        document.querySelector('[onclick="exportMetrics()"]').innerHTML = '<i class="fas fa-download"></i> Export';
    }
}

function switchChart(chartType, view) {
    if (chartType === 'performance') {
        currentChartView = view;
        
        // Update button states - fix the selector
        const buttonGroup = document.querySelector('.card-header .btn-group');
        if (buttonGroup) {
            buttonGroup.querySelectorAll('.btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }
        
        // Update chart based on view with real data filtering
        updatePerformanceChartView(view);
    }
}

function updatePerformanceChartView(view) {
    if (!performanceChart) return;
    
    // Update chart title and data based on view
    let label, color;
    switch(view) {
        case 'executions':
            label = 'Pipeline Executions';
            color = '#007bff';
            break;
        case 'duration':
            label = 'Average Duration (seconds)';
            color = '#28a745';
            break;
        case 'errors':
            label = 'Error Count';
            color = '#dc3545';
            break;
        default:
            label = 'Executions';
            color = '#007bff';
    }
    
    // Update chart configuration
    performanceChart.data.datasets[0].label = label;
    performanceChart.data.datasets[0].borderColor = color;
    performanceChart.data.datasets[0].backgroundColor = color + '20'; // Add transparency
    
    // Refresh chart with current metrics
    loadMetrics();
}

function switchActivityView(view) {
    currentActivityView = view;
    // Update button states
    document.querySelectorAll('[onclick*="switchActivityView"]').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    loadActivity();
}

function viewPipelineDetails(pipelineName) {
    window.location.href = `/pipelines/${pipelineName}`;
}

// Time range change handler
document.addEventListener('change', function(e) {
    if (e.target.name === 'timeRange') {
        currentTimeRange = e.target.value;
        loadMetrics();
    }
});

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    initCharts();
    loadMetrics();
    loadActivity();
    
    // CONTROLLED auto-refresh with memory management - reduced frequency to prevent overload
    let refreshInterval = setInterval(() => {
        // Only refresh if page is visible to prevent unnecessary resource usage
        if (document.visibilityState === 'visible') {
            loadMetrics();
            loadActivity();
        }
    }, 120000); // Increased to 2 minutes from 1 minute
    
    // Clean up interval when page becomes hidden to prevent memory leaks
    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'hidden') {
            clearInterval(refreshInterval);
        } else {
            // Restart interval when page becomes visible again
            refreshInterval = setInterval(() => {
                if (document.visibilityState === 'visible') {
                    loadMetrics();
                    loadActivity();
                }
            }, 120000);
        }
    });
});
</script>
{% endblock %}